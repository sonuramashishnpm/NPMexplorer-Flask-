<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NPMnews - Your Daily News Source</title>

<link rel="stylesheet" href="{{url_for('static', filename='NPMnewsstyle.css')}}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="{{ url_for('static', filename='NPMnew.png') }}" type="image/png">
</head>

<body>

<header class="site-header">
  <div class="header-content">
    <h1 class="logo">NPMnews</h1>
    <div class="date-display" id="current-date"></div>
  </div>
</header>

<div class="news-ticker">
  <div class="ticker-label">BREAKING:</div>
  <span>India launches new AI-driven education initiative | Global climate talks resume | Sensex gains</span>
</div>

<aside>
  <button onclick="openAIChat()" class="buttonhome">AI</button>
</aside>

<div class="main-container">
  <div class="left-section">
    <article class="news-article">
      <h4>Live Auto News Feed</h4>
      <div id="rss-news"><p>Loading headlines...</p></div>
    </article>
  </div>
</div>

<!-- ================= AI CHAT MODAL ================= -->
<div id="ai-chat-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999;">
  <div style="background:#fff;width:90%;max-width:700px;height:80%;margin:5% auto;border-radius:8px;display:flex;flex-direction:column;">
    <div style="padding:10px;background:#111;color:#fff;display:flex;justify-content:space-between;">
      <strong>NPM AI News Assistant</strong>
      <button onclick="closeAIChat()" style="background:red;color:#fff;border:none;">X</button>
    </div>

    <div id="ai-messages" style="flex:1;padding:10px;overflow-y:auto;font-size:14px;"></div>

    <div style="display:flex;padding:10px;border-top:1px solid #ccc;">
      <input id="ai-input" placeholder="Ask about today's news..." style="flex:1;padding:10px;">
      <button onclick="sendAIMessage()" style="padding:10px;">Send</button>
    </div>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
/* -------- DATE -------- */
document.getElementById("current-date").innerText =
  new Date().toLocaleDateString("en-IN",{weekday:'long',year:'numeric',month:'long',day:'numeric'});

/* -------- RSS FEEDS -------- */
const rssFeeds = [
  { url: 'https://feeds.bbci.co.uk/news/world/rss.xml', label: 'BBC' },
  { url: 'https://www.aljazeera.com/xml/rss/all.xml', label: 'Al Jazeera' },
  { url: 'https://indianexpress.com/section/india/feed/', label: 'Indian Express' },
  { url: 'https://www.thehindu.com/news/national/feeder/default.rss', label: 'The Hindu' }
];

async function loadRSS() {
  const container = document.getElementById("rss-news");
  container.innerHTML = "";

  for (const feed of rssFeeds) {
    try {
      const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`);
      const data = await res.json();

      const section = document.createElement("div");
      section.innerHTML = `<h3>${feed.label}</h3>`;

      data.items.slice(0, 3).forEach(item => {
        const div = document.createElement("div");
        div.innerHTML = `<h4>${item.title}</h4><p>${item.contentSnippet || ""}</p>`;
        section.appendChild(div);
      });

      container.appendChild(section);
    } catch {
      container.innerHTML += `<p>Failed to load ${feed.label}</p>`;
    }
  }
}
loadRSS();

/* ================= AI LOGIC ================= */
let aiInitialized = false;

function openAIChat() {
  document.getElementById("ai-chat-modal").style.display = "block";
  if (!aiInitialized) summarizeNews();
  aiInitialized = true;
}

function closeAIChat() {
  document.getElementById("ai-chat-modal").style.display = "none";
}

function collectNewsText() {
  let text = "";
  document.querySelectorAll("#rss-news h4").forEach((h, i) => {
    text += `${i+1}. ${h.innerText}\n`;
  });
  return text.slice(0, 12000);
}

async function summarizeNews() {
  const box = document.getElementById("ai-messages");
  box.innerHTML += `<div><b>AI:</b> Summarizing today's news...</div>`;

  const res = await fetch("https://npmai-api.onrender.com/llm", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      model: "llama3.2",
      prompt: "Summarize today's news headlines:\n\n" + collectNewsText()
    })
  });

  const data = await res.json();
  box.innerHTML += `<div><b>AI:</b> ${data.response}</div>`;
}

async function sendAIMessage() {
  const input = document.getElementById("ai-input");
  const msg = input.value.trim();
  if (!msg) return;

  const box = document.getElementById("ai-messages");
  box.innerHTML += `<div><b>You:</b> ${msg}</div>`;
  input.value = "";

  const res = await fetch("https://npmai-api.onrender.com/llm", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      model: "llama3.2",
      prompt: msg
    })
  });

  const data = await res.json();
  box.innerHTML += `<div><b>AI:</b> ${data.response}</div>`;
  box.scrollTop = box.scrollHeight;
}
</script>

</body>
</html>
