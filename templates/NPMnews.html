<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPMnews - Your Daily News Source</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='NPMnewsstyle.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="site-header">
        <div class="header-content">
            <h1 class="logo">NPMnews</h1>
            <div class="date-display" id="current-date"></div>
        </div>
    </header>

    <div class="news-ticker">
        <div class="ticker-label">BREAKING:</div>
        <span>India launches new AI-driven education initiat | Global climate talks resume in Geneva | Sensex gains 150 points in early trading</span>
    </div>

    <!-- ðŸ”¥ AI BUTTON -->
    <aside>
        <div><button onclick="openAIChat()" class="buttonhome">ðŸ¤– AI</button></div>
    </aside>

    <div class="main-container">
        <div class="left-section">
            <article class="news-article">
                <div class="article-icon">ðŸ†•</div>
                <div class="article-content">
                    <h4>Live Auto News Feed</h4>
                    <div id="rss-news" style="background: #f1f1f1; padding: 1rem; border-radius: 4px;">
                        <p>Loading headlines...</p>
                    </div>
                </div>
            </article>
        </div>
        
        <div class="right-section">
            <div class="header">
                <h2 id="h2"><i class="fas fa-tv"></i> NPMtv</h2>
            </div>
            <div class="video-container">
                <div class="video-wrapper"></div>
            </div>
            <div class="trending-now">
                <h3><i class="fas fa-fire"></i> Trending Now</h3>
                <ul class="trending-list">
                    <li>AI education initiative sparks debate</li>
                    <li>Cyclone aftermath in Australia</li>
                    <li>IPL finals preview</li>
                    <li>New climate resilience fund</li>
                    <li>Bullet train progress</li>
                </ul>
            </div>
            <div class="loading-spinner" id="news-spinner">
                <div class="spinner"></div>
                <p>Loading latest updates...</p>
            </div>
        </div>
    </div>

    <!-- ================= AI CHAT MODAL ================= -->
    <div id="ai-chat-modal" class="ai-modal" style="display:none;">
        <div class="ai-box">
            <div class="ai-header">
                <strong>NPM AI News Assistant</strong>
                <button onclick="closeAIChat()">âœ–</button>
            </div>
            <div id="ai-messages" class="ai-messages"></div>
            <div class="ai-input-box">
                <input id="ai-input" placeholder="Ask about today's news..." />
                <button onclick="sendAIMessage()">Send</button>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-logo">NPMnews</div>
            <div class="footer-links">
                <a href="#">About Us</a>
                <a href="#">Contact</a>
                <a href="#">Advertise</a>
                <a href="#">Careers</a>
                <a href="#">Privacy Policy</a>
            </div>
            <div class="social-links">
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-youtube"></i></a>
            </div>
            <div class="copyright">Â© 2025 NPMnews. All rights reserved.</div>
        </div>
    </footer>

    <div class="back-to-top" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </div>

    <script>
        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date();
            document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', options);
        }

        async function fetchNews() {
            const spinner = document.getElementById("news-spinner");
            spinner.classList.add("active");
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                document.getElementById("news-spinner").innerHTML = `<p>Latest updates loaded successfully!</p>`;
                setTimeout(() => spinner.classList.remove("active"), 2000);
            } catch (error) {
                document.getElementById("news-spinner").innerHTML = "<p>Failed to load news.</p>";
                setTimeout(() => spinner.classList.remove("active"), 2000);
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        const rssFeeds = [
            { url: 'https://feeds.feedburner.com/ndtvnews-top-stories', label: 'NDTV' },
            { url: 'https://www.reutersagency.com/feed/?best-topics=world', label: 'Reuters' },
            { url: 'https://feeds.bbci.co.uk/news/world/rss.xml', label: 'BBC' },
            { url: 'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml', label: 'NYTimes' },
            { url: 'https://www.aljazeera.com/xml/rss/all.xml', label: 'Al Jazeera' },
            { url: 'https://rss.dw.com/rdf/rss-en-world', label: 'DW World' },
            { url: 'https://www.cbsnews.com/latest/rss/main', label: 'CBS News' },
            { url: 'https://www.npr.org/rss/rss.php?id=1001', label: 'NPR Top News' },
            { url: 'https://www.hindustantimes.com/feeds/rss/india-news/rssfeed.xml', label: 'Hindustan Times (India)' },
            { url: 'https://indianexpress.com/section/india/feed/', label: 'Indian Express (India)' }
            // truncated for brevity
        ];

        async function loadRSS() {
            const container = document.getElementById("rss-news");
            container.innerHTML = "";

            for (const feed of rssFeeds) {
                try {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`);
                    const data = await res.json();

                    const section = document.createElement("div");
                    section.innerHTML = `<h3 style="color:darkblue;">${feed.label}</h3>`;
                    section.style.marginBottom = "20px";

                    data.items.slice(0, 3).forEach(item => {
                        const div = document.createElement("div");
                        div.style.marginBottom = "10px";
                        div.style.padding = "10px";
                        div.style.borderBottom = "1px solid #ccc";

                        const title = document.createElement("h4");
                        title.textContent = item.title;

                        const content = document.createElement("p");
                        content.textContent = item.contentSnippet || item.description;
                        content.style.display = "none";
                        content.style.marginTop = "10px";

                        const readMore = document.createElement("a");
                        readMore.href = "#";
                        readMore.textContent = "Read more";
                        readMore.onclick = (e) => {
                            e.preventDefault();
                            content.style.display = content.style.display === "none" ? "block" : "none";
                            readMore.textContent = content.style.display === "block" ? "Hide" : "Read more";
                        };

                        const speakBtn = document.createElement("button");
                        speakBtn.textContent = "ðŸ”Š English";
                        speakBtn.style.marginLeft = "10px";
                        speakBtn.onclick = () => speakText(`${item.title}. ${item.contentSnippet}`, 'en-US');

                        const speakBtnHindi = document.createElement("button");
                        speakBtnHindi.textContent = "ðŸ”Š à¤¹à¤¿à¤‚à¤¦à¥€";
                        speakBtnHindi.style.marginLeft = "5px";
                        speakBtnHindi.onclick = () => speakText(`${item.title}. ${item.contentSnippet}`, 'hi-IN');

                        div.appendChild(title);
                        div.appendChild(readMore);
                        div.appendChild(speakBtn);
                        div.appendChild(speakBtnHindi);
                        div.appendChild(content);
                        section.appendChild(div);
                    });

                    container.appendChild(section);
                } catch (err) {
                    const errorDiv = document.createElement("div");
                    errorDiv.innerHTML = `<p>Failed to load feed from ${feed.label}</p>`;
                    container.appendChild(errorDiv);
                }
            }
        }

        function speakText(text, lang = 'en') {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            speechSynthesis.speak(utterance);
        }

        const ytFeeds = [
            { url: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCZFMm1mMw0F81Z37aaEzTUA', label: 'NDTV' },
            { url: 'https://www.youtube.com/feeds/videos.xml?channel_id=UC16niRr50-MSBwiO3YDb3RA', label: 'BBC' },
            { url: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCpVm7bg6pXKo1Pr6k5kxG9A', label: 'WION' },
            { url: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCAY2xH_T8ueW2k9kV7t1Ilg', label: 'India Today' },
            { url: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCNye-wNBqNL5ZzHSJj3l8Bg', label: 'ABC News' },
            { url: 'https://www.youtube.com/feeds/videos.xml?channel_id=UCVHFbqXqoYvEWM1Ddxl0QwA', label: 'Al Jazeera English' }
        ];

        async function loadYouTubeVideos() {
            const container = document.querySelector('.video-container');
            container.innerHTML = '';
            for (const feed of ytFeeds) {
                try {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`);
                    const data = await res.json();
                    const video = data.items[0];
                    const videoId = video.link.split('=')[1];

                    const wrapper = document.createElement('div');
                    wrapper.className = 'video-wrapper';
                    wrapper.innerHTML = `
                        <iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
                        <div class="video-caption">${feed.label} - ${video.title}</div>
                    `;
                    container.appendChild(wrapper);
                } catch (err) {
                    console.error(`Failed to load ${feed.label}`, err);
                }
            }
        }

        // ================= AI LOGIC =================
        let aiInit = false;

        function openAIChat() {
            document.getElementById("ai-chat-modal").style.display = "block";
            if (!aiInit) summarizeNews();
            aiInit = true;
        }

        function closeAIChat() {
            document.getElementById("ai-chat-modal").style.display = "none";
        }

        function collectNewsText() {
            let t = "";
            document.querySelectorAll("#rss-news p").forEach(p => t += p.innerText + "\n");
            return t.slice(0,12000);
        }

        async function summarizeNews() {
            const box = document.getElementById("ai-messages");
            box.innerHTML += `<div><b>AI:</b> Summarizing today's news...</div>`;

            const res = await fetch("https://npmai-api.onrender.com/llm", {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({
                    model:"llama3.2",
                    prompt:"Summarize today's news:\n" + collectNewsText()
                })
            });

            const data = await res.json();
            box.innerHTML += `<div><b>AI:</b> ${data.response}</div>`;
        }

        async function sendAIMessage() {
            const input = document.getElementById("ai-input");
            const msg = input.value.trim();
            if (!msg) return;

            const box = document.getElementById("ai-messages");
            box.innerHTML += `<div><b>You:</b> ${msg}</div>`;
            input.value = "";

            const res = await fetch("https://npmai-api.onrender.com/llm", {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({ model:"llama3.2", prompt:msg })
            });

            const data = await res.json();
            box.innerHTML += `<div><b>AI:</b> ${data.response}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateDate();
            fetchNews();
            setInterval(fetchNews, 15000);
            loadRSS();
            setInterval(loadRSS, 1800000);
            loadYouTubeVideos();
            setInterval(loadYouTubeVideos, 1800000);
        });
    </script>
</body>
</html>
